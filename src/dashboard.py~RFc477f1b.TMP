import streamlit as st
import pandas as pd
from st_aggrid import AgGrid

from src.config import (
    DATA_PATH,
    DIFFICULTY_CENTER,
    DIFFICULTY_COLORS,
    COLOR_OPACITY
)

from src.data import load_and_prepare_data, calculate_gameweeks, prepare_ranking_display
from src.pivots import create_pivot_tables, prepare_grid_dataframe
from src.grid import create_cell_style_js, configure_grid


def main():
    # Header section with better formatting
    st.markdown("# ‚öΩ Opponent Difficulty Dashboard")
    st.markdown("### Analyze fixture difficulty across competitions and gameweeks")
    st.markdown("<hr>", unsafe_allow_html=True)

    # Load and prepare data
    try:
        df = load_and_prepare_data(DATA_PATH)
        df = calculate_gameweeks(df)
        df = prepare_ranking_display(df)
    except FileNotFoundError:
        st.error(f"‚ùå Data file not found at: {DATA_PATH}")
        st.info("üí° Please ensure the CSV file is in the correct location.")
        st.stop()
    except Exception as e:
        st.error(f"‚ùå Error loading data: {str(e)}")
        st.stop()

    # Sidebar filters with icons
    st.sidebar.markdown("## üéØ Filters")

    # Competition filter
    competitions = sorted(df["Competition_Display"].dropna().unique())
    competition = st.sidebar.selectbox(
        "‚öΩ Competition",
        competitions,
        help="Select a competition to analyze"
    )

    df_filtered = df[df["Competition_Display"] == competition]

    # Position filter
    positions = sorted(df_filtered["Position"].dropna().unique())
    position = st.sidebar.selectbox(
        "üë§ Position",
        positions,
        help="Filter by player position"
    )

    df_filtered = df_filtered[df_filtered["Position"] == position]

    # Metric selection
    metric = st.sidebar.radio(
        "üìä Metric",
        ["Score_mean", "Score_median"],
        format_func=lambda x: x.replace("_", " ").title(),
        help="Choose between mean or median difficulty scores"
    )

    # Gameweek selection
    gameweeks = sorted(df_filtered["Game Week"].unique())

    st.sidebar.markdown("---")
    
    selected_gameweeks = st.sidebar.multiselect(
        "üìÖ Gameweeks",
        gameweeks,
        default=gameweeks,
        format_func=lambda x: f"GW {x}",
        help="Select which gameweeks to display"
    )

    if not selected_gameweeks:
        st.warning("‚ö†Ô∏è Please select at least one gameweek to display.")
        st.stop()

    df_filtered = df_filtered[df_filtered["Game Week"].isin(selected_gameweeks)]

    # Create pivot tables
    value_pivot, label_pivot, opponent_pivot = create_pivot_tables(df_filtered, metric)

    # Prepare grid dataframe
    grid_df, gw_columns = prepare_grid_dataframe(
        value_pivot,
        label_pivot,
        opponent_pivot,
        df_filtered,
        selected_gameweeks
    )

    # Create cell styling
    cell_js = create_cell_style_js(
        DIFFICULTY_CENTER,
        DIFFICULTY_COLORS,
        COLOR_OPACITY
    )

    # Configure grid options
    grid_options = configure_grid(grid_df, gw_columns, cell_js)

    # Display metrics summary
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("Teams", len(grid_df))
    with col2:
        st.metric("Gameweeks", len(selected_gameweeks))
    with col3:
        avg_difficulty = grid_df["Avg__val"].mean()
        st.metric("Avg Difficulty", f"{avg_difficulty:.1f}")

    st.markdown("---")

    # Display the grid with responsive height
    # Use smaller height on mobile, larger on desktop
    grid_height = 600  # Default height that works well on mobile

    AgGrid(
        grid_df,
        gridOptions=grid_options,
        height=grid_height,
        allow_unsafe_jscode=True,
        theme="streamlit",
        update_mode="NO_UPDATE",
        fit_columns_on_grid_load=False
    )

    # Export section
    st.markdown("---")
    
    # Better mobile layout for download section
    st.markdown("### üì• Export Data")
    st.markdown("Download the current view as a CSV file for further analysis.")
    
    export_df = grid_df[["Rank", "Name"] + gw_columns + ["Avg"]]
    
    st.download_button(
        "üìä Download CSV",
        export_df.to_csv(index=False).encode(),
        "opponent_difficulty.csv",
        "text/csv",
        help="Download the filtered data as CSV"
    )
    
    # Footer with color legend - stacked on mobile
    st.markdown("---")
    st.markdown("### üé® Color Legend")
    
    legend_col1, legend_col2, legend_col3 = st.columns(3)
    
    with legend_col1:
        st.markdown(
            '<div style="background-color: rgb(34, 197, 94); padding: 10px; '
            'border-radius: 8px; text-align: center; color: white; font-weight: 600; '
            'margin-bottom: 0.5rem;">'
            'Easy</div>',
            unsafe_allow_html=True
        )
    
    with legend_col2:
        st.markdown(
            '<div style="background-color: rgb(255, 255, 255); padding: 10px; '
            'border-radius: 8px; text-align: center; border: 1px solid #cbd5e1; '
            'font-weight: 600; margin-bottom: 0.5rem;">Neutral</div>',
            unsafe_allow_html=True
        )
    
    with legend_col3:
        st.markdown(
            '<div style="background-color: rgb(239, 68, 68); padding: 10px; '
            'border-radius: 8px; text-align: center; color: white; font-weight: 600; '
            'margin-bottom: 0.5rem;">'
            'Hard</div>',
            unsafe_allow_html=True
        )
